!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).cookieManager=t()}(this,(function(){"use strict";var e=function(){return e=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},e.apply(this,arguments)},t=function(){function t(t){var n,o;this.defaultConfig={userPreferences:{cookieName:"cookie-preferences",cookieExpiry:365,cookieSecure:0},preferencesForm:{class:"cookie-preferences-form"},cookieBanner:{class:"cookie-banner",showWithPreferencesForm:0,actions:[{name:"accept",buttonClass:"cookie-banner-accept-button",confirmationClass:"cookie-banner-accept-message",consent:1},{name:"reject",buttonClass:"cookie-banner-reject-button",confirmationClass:"cookie-banner-reject-message",consent:0},{name:"hide",buttonClass:"cookie-banner-hide-button"}]},cookieManifest:[],additionalOptions:{deleteUndefinedCookies:1,defaultConsent:0}},this.activeConfig={},t?(this.activeConfig.userPreferences=e(e({},this.defaultConfig.userPreferences),t.userPreferences),this.activeConfig.preferencesForm=null!==(n=t.preferencesForm)&&void 0!==n?n:this.defaultConfig.preferencesForm,this.activeConfig.cookieBanner=e(e({},this.defaultConfig.cookieBanner),t.cookieBanner),this.activeConfig.cookieManifest=null!==(o=t.cookieManifest)&&void 0!==o?o:this.defaultConfig.cookieManifest,this.activeConfig.additionalOptions=e(e({},this.defaultConfig.additionalOptions),t.additionalOptions)):this.activeConfig=this.defaultConfig}return t.prototype.getUserPreferencesCookieName=function(){return this.activeConfig.userPreferences.cookieName},t.prototype.getUserPreferencesCookieExpiry=function(){return this.activeConfig.userPreferences.cookieExpiry},t.prototype.getUserPreferencesCookieSecure=function(){return this.activeConfig.userPreferences.cookieSecure},t.prototype.getPreferencesFormConfiguration=function(){return this.activeConfig.preferencesForm},t.prototype.getCookieBannerConfiguration=function(){return this.activeConfig.cookieBanner},t.prototype.getCookieManifest=function(){return this.activeConfig.cookieManifest},t.prototype.getDefaultConsent=function(){return this.activeConfig.additionalOptions.defaultConsent},t.prototype.shouldDeleteUncategorized=function(){return this.activeConfig.additionalOptions.deleteUndefinedCookies},t}(),n=function(){function e(e,t,n,o){void 0===t&&(t=[]),void 0===n&&(n=1),void 0===o&&(o="startsWith"),this.name=e,this.cookies=t,this.optional=n,this.matchBy=o}return e.prototype.getName=function(){return this.name},e.prototype.getCookies=function(){return this.cookies},e.prototype.getMatchBy=function(){return this.matchBy},e.prototype.isOptional=function(){return this.optional},e}(),o=function(){function e(e){this.config=e}return e.prototype.getCategoryByCookieName=function(t){if(t===this.config.getUserPreferencesCookieName())return new n("__cookie-manager",[],0);var o=this.getCategories().find((function(e){return e.getCookies().some((function(n){switch(e.getMatchBy()){case"startsWith":return t.startsWith(n);case"exact":return t===n;case"includes":return t.includes(n);default:return 0}}))}));return null!=o?o:new n(e.DEFAULTS.UNDEFINED_CATEGORY_NAME)},e.prototype.getCategories=function(){return this.config.getCookieManifest().filter((function(e){return e.categoryName&&Array.isArray(e.cookies)?1:(console.debug("Malformed cookie manifest category, ignoring."),0)})).map((function(e){return new n(e.categoryName,e.cookies,e.optional,e.matchBy)}))},e.DEFAULTS={UNDEFINED_CATEGORY_NAME:"un-categorized"},e}(),r=function(){function e(e,t){this.name=e,this.value=t}return e.prototype.getName=function(){return this.name},e.prototype.getValue=function(){return this.value},e}(),i=function(){function e(e,t,n){this.config=e,this.manifestHandler=t,this.userPreferences=n}return e.prototype.processCookies=function(){this.config.shouldDeleteUncategorized()&&this._processUnCategorizedCookies(),this._processNonConsentedCookies()},e.prototype._processNonConsentedCookies=function(){var t=this;console.debug("Deleting non-consented cookies"),e.getAllCookies().filter((function(e){var n=t.manifestHandler.getCategoryByCookieName(e.getName());return n.getName()!==o.DEFAULTS.UNDEFINED_CATEGORY_NAME&&n.isOptional()&&!t.userPreferences.getPreferences()[n.getName()]})).forEach((function(t){return e.deleteCookie(t)}))},e.prototype._processUnCategorizedCookies=function(){var t=this;console.debug("Deleting non-categorized cookies"),e.getAllCookies().filter((function(e){return t.manifestHandler.getCategoryByCookieName(e.getName()).getName()===o.DEFAULTS.UNDEFINED_CATEGORY_NAME})).forEach((function(t){return e.deleteCookie(t)}))},e.getAllCookies=function(){return decodeURIComponent(document.cookie).split(";").filter((function(e){return e.length})).map((function(e){var t=e.split(/=(.*)/s);return new r(t[0].trim(),t[1].trim())}))},e.getCookie=function(t){return e.getAllCookies().find((function(e){return e.getName()===t}))},e.saveCookie=function(e,t,n){var o=new Date;o.setDate(o.getDate()+t);var r=e.getName()+"=";r+="object"==typeof e.getValue()?JSON.stringify(e.getValue()):e.getValue(),r+=t?";expires="+o.toUTCString():"",r+=n?";secure":"",r+=";path=/;",document.cookie=r,console.debug("Saved '".concat(e.getName(),"' cookie"))},e.deleteCookie=function(e){console.debug("Deleting cookie: "+e.getName());var t=window.location.hostname,n=t.substring(t.indexOf(".")),o=new Date(-1).toUTCString();[t,"."+t,n,"."+n].forEach((function(t){document.cookie=e.getName()+"=;expires="+o+";domain="+t+";path=/;"}))},e}(),s=function(){function e(){}return e.on=function(t,n){if("string"==typeof t){if("function"==typeof n){t=t.toLowerCase();var o=Math.random().toString(16).slice(2);return e._handlerMap.has(t)||e._handlerMap.set(t,new Map),e._handlerMap.get(t).set(o,n),{type:t,token:o}}console.error("No callback function provided")}else console.error("Event not provided")},e.off=function(t){var n,o;try{n=t.type.toLowerCase(),o=t.token}catch(e){return void console.error("Missing or malformed event token provided")}e._handlerMap.has(n)&&e._handlerMap.get(n).delete(o)},e.emit=function(t,n){t=t.toLowerCase(),console.debug("Event fired: "+t),e._handlerMap.has(t)&&e._handlerMap.get(t).forEach((function(e){return e(n)}))},e._handlerMap=new Map,e}(),c=function(){function e(e,t){this.config=e,this.manifestHandler=t}return e.prototype.processPreferences=function(){var e=this.getPreferenceCookie();this.setPreferences(e?this._loadPreferencesFromCookie():this._loadPreferenceDefaults())},e.prototype.getPreferences=function(){return this.preferences?this.preferences:(console.error("User preferences not loaded/set, call .processPreferences() first"),{})},e.prototype.setPreferences=function(e){console.debug("Setting preferences to: "+JSON.stringify(e)),this.preferences=e,s.emit("UserPreferencesSet",e)},e.prototype.getPreferenceCookie=function(){return i.getCookie(this.config.getUserPreferencesCookieName())},e.prototype.savePreferencesToCookie=function(){var e={},t=this.getPreferences();Object.keys(t).forEach((function(n){e[n]=t[n]?"on":"off"}));var n=new r(this.config.getUserPreferencesCookieName(),e);i.saveCookie(n,this.config.getUserPreferencesCookieExpiry(),this.config.getUserPreferencesCookieSecure()),s.emit("UserPreferencesSaved",e)},e.prototype._loadPreferencesFromCookie=function(){var e,t=this.getPreferenceCookie();try{console.debug("Loading preferences from cookie"),e=JSON.parse(t.getValue())}catch(e){return console.error('Unable to parse user preference cookie "'.concat(t.getName(),'" as JSON.')),i.deleteCookie(t),this._loadPreferenceDefaults()}if("object"!=typeof e)return console.debug("User preferences cookie is malformed, deleting old user preferences cookie."),i.deleteCookie(t),this._loadPreferenceDefaults();if(this.manifestHandler.getCategories().filter((function(e){return e.isOptional()})).some((function(t){return!Object.keys(e).includes(t.getName())})))return console.debug("User preferences cookie is missing categories, deleting old user preferences cookie."),i.deleteCookie(t),this._loadPreferenceDefaults();var n={};return Object.keys(e).forEach((function(t){n[t]="on"===e[t]})),s.emit("UserPreferencesLoaded",e),n},e.prototype._loadPreferenceDefaults=function(){var e=this;console.debug("Loading preferences from defaults");var t={},n={};return this.manifestHandler.getCategories().filter((function(e){return e.isOptional()})).forEach((function(o){t[o.getName()]=e.config.getDefaultConsent(),n[o.getName()]=e.config.getDefaultConsent()?"on":"off"})),s.emit("UserPreferencesLoaded",n),t},e}(),a=function(){function e(e,t,n){this.config=e,this.userPreferencesHandler=t,this.cookieHandler=n}return e.prototype.init=function(){var e=this;if(!this.userPreferencesHandler.getPreferenceCookie())return"loading"===document.readyState?(console.debug("DOM is not ready; adding event to bind to banner when ready."),void document.addEventListener("DOMContentLoaded",(function(){return e.init()}))):void(this._getBannerNode()&&(document.getElementsByClassName(this.config.getPreferencesFormConfiguration().class)[0]&&!this.config.getCookieBannerConfiguration().showWithPreferencesForm||(this._setupEventListeners(),this._getBannerNode().hidden=0,s.emit("CookieBannerInitialized"))))},e.prototype._setupEventListeners=function(){var e,t=this;((null===(e=this.config.getCookieBannerConfiguration())||void 0===e?void 0:e.actions)||[]).forEach((function(e){t._getBannerNode().querySelectorAll("."+e.buttonClass).forEach((function(n){n.addEventListener("click",(function(n){t._clickEventHandler(n,e.name,e.confirmationClass,e.consent)}))}))}))},e.prototype._clickEventHandler=function(e,t,n,o){var r,i;if(e.preventDefault(),s.emit("CookieBannerAction",t),n)try{for(var c=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],o=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&o>=e.length&&(e=void 0),{value:e&&e[o++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(this._getBannerNode().children),a=c.next();!a.done;a=c.next()){var f=a.value;f.hidden=!f.classList.contains(n)}}catch(e){r={error:e}}finally{try{a&&!a.done&&(i=c.return)&&i.call(c)}finally{if(r)throw r.error}}else this._getBannerNode().hidden=1;if(void 0!==o){var u=this.userPreferencesHandler.getPreferences();"boolean"==typeof o&&Object.keys(u).forEach((function(e){u[e]=o})),Array.isArray(o)&&o.forEach((function(e){u[e]=1})),this._updatePreferences(u)}},e.prototype._updatePreferences=function(e){this.userPreferencesHandler.setPreferences(e),this.userPreferencesHandler.savePreferencesToCookie(),this.cookieHandler.processCookies()},e.prototype._getBannerNode=function(){var e;return document.querySelector("."+(null===(e=this.config.getCookieBannerConfiguration())||void 0===e?void 0:e.class))},e}(),f=function(){function e(e,t,n){this.config=e,this.userPreferencesHandler=t,this.cookieHandler=n}return e.prototype.init=function(){var e=this;if("loading"===document.readyState)return console.debug("DOM is not ready; adding event to bind to preference form when ready."),void document.addEventListener("DOMContentLoaded",(function(){return e.init()}));this._getPreferencesForm()&&(this._setupEventListeners(),this._configureFormRadios(),s.emit("PreferenceFormInitialized"))},e.prototype._getPreferencesForm=function(){return document.getElementsByClassName(this.config.getPreferencesFormConfiguration().class)[0]},e.prototype._setupEventListeners=function(){var e=this;this._getPreferencesForm().addEventListener("submit",(function(t){return e._submitEventHandler(t)}))},e.prototype._submitEventHandler=function(e){e.preventDefault();var t={};e.target.querySelectorAll('input[type="radio"]:checked').forEach((function(e){var n=e.getAttribute("name"),o=e.getAttribute("value");t[n]="on"===o})),s.emit("PreferenceFormSubmitted",t),this._updatePreferences(t)},e.prototype._updatePreferences=function(e){this.userPreferencesHandler.setPreferences(e),this.userPreferencesHandler.savePreferencesToCookie(),this.cookieHandler.processCookies()},e.prototype._configureFormRadios=function(){var e=this;Object.entries(this.userPreferencesHandler.getPreferences()).forEach((function(t){var n=t[1]?"on":"off",o=e._getPreferencesForm().querySelector("input[name=".concat(t[0],"][value=").concat(n,"]"));o&&(o.checked=1)}))},e}();return{init:function(e){console.debug("CookieManager initializing...");var n=new t(e),r=new o(n),u=new c(n,r),d=new i(n,r,u);u.processPreferences(),Object.keys(n.getCookieBannerConfiguration())&&new a(n,u,d).init(),Object.keys(n.getPreferencesFormConfiguration())&&new f(n,u,d).init(),s.emit("CookieManagerLoaded"),d.processCookies()},on:s.on,off:s.off}}));
